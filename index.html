<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dunk the Baby Seal Pup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', cursive;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #1E90FF 50%, #0066AA 100%);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 10px;
        }

        .title {
            font-size: 2.5em;
            color: #2C3E50;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            margin-bottom: 5px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.8);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .control-group label {
            font-weight: bold;
            color: #2C3E50;
        }

        select {
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #2C3E50;
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.2em;
            font-family: inherit;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            font-weight: bold;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-start {
            background: #1a1a1a;
            color: white;
            box-shadow: 0 4px 0 #000;
        }

        .btn-retry {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: #2C3E50;
            box-shadow: 0 4px 0 #B8860B;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .scene {
            position: relative;
            height: 300px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 60%, transparent 60%);
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(180deg, #4AA3DF 0%, #1E5F8A 100%);
        }

        .ice-flow {
            position: absolute;
            bottom: 55%;
            left: 10%;
            width: 120px;
            height: 40px;
            background: linear-gradient(180deg, #FFFFFF 0%, #E8F4F8 50%, #B8D4E8 100%);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .seal {
            position: absolute;
            bottom: 58%;
            left: 12%;
            width: 80px;
            height: 60px;
            transition: all 0.8s ease-in-out;
            z-index: 10;
        }

        .seal.diving {
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
        }

        .seal.swimming {
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%);
            animation: swim 2s ease-in-out infinite;
        }

        .seal.returning {
            bottom: 58%;
            left: 12%;
            transform: none;
            animation: none;
        }

        @keyframes swim {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .seal-body {
            position: relative;
            width: 80px;
            height: 50px;
            background: linear-gradient(180deg, #8B9DC3 0%, #6B7AA1 100%);
            border-radius: 40px 60px 50px 40px;
        }

        .seal-head {
            position: absolute;
            right: -15px;
            top: 5px;
            width: 35px;
            height: 30px;
            background: linear-gradient(180deg, #8B9DC3 0%, #6B7AA1 100%);
            border-radius: 50%;
        }

        .seal-eye {
            position: absolute;
            right: -5px;
            top: 12px;
            width: 10px;
            height: 12px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .seal-eye::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
        }

        .seal-nose {
            position: absolute;
            right: -20px;
            top: 18px;
            width: 12px;
            height: 8px;
            background: #2C3E50;
            border-radius: 50%;
        }

        .seal-whiskers {
            position: absolute;
            right: -25px;
            top: 20px;
        }

        .seal-whiskers::before,
        .seal-whiskers::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 2px;
            background: #4A5568;
        }

        .seal-whiskers::before {
            transform: rotate(-15deg);
            top: -3px;
        }

        .seal-whiskers::after {
            transform: rotate(15deg);
            top: 3px;
        }

        .seal-flipper {
            position: absolute;
            bottom: -5px;
            left: 20px;
            width: 25px;
            height: 15px;
            background: #6B7AA1;
            border-radius: 50% 50% 50% 20%;
            transform: rotate(-20deg);
        }

        .seal-tail {
            position: absolute;
            left: -10px;
            bottom: 5px;
            width: 20px;
            height: 25px;
            background: #6B7AA1;
            border-radius: 50% 20% 50% 50%;
            transform: rotate(30deg);
        }

        .bandaid {
            position: absolute;
            top: 15px;
            left: 25px;
            width: 25px;
            height: 12px;
            background: #FFD5B5;
            border-radius: 3px;
            display: none;
            z-index: 5;
        }

        .bandaid::before,
        .bandaid::after {
            content: '';
            position: absolute;
            top: 3px;
            width: 4px;
            height: 6px;
            background: #E8C4A8;
            border-radius: 1px;
        }

        .bandaid::before { left: 4px; }
        .bandaid::after { right: 4px; }

        .bandaid.visible {
            display: block;
        }

        .shark {
            position: absolute;
            bottom: 10%;
            right: -150px;
            width: 120px;
            height: 60px;
            transition: right 1s ease-in-out;
            z-index: 5;
        }

        .shark.attacking {
            right: 35%;
        }

        .shark-body {
            position: relative;
            width: 100px;
            height: 50px;
            background: linear-gradient(180deg, #8B5CF6 0%, #6D28D9 100%);
            border-radius: 50px 20px 20px 50px;
        }

        .shark-fin {
            position: absolute;
            top: -20px;
            left: 40px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 30px solid #7C3AED;
        }

        .shark-tail {
            position: absolute;
            right: -20px;
            top: 10px;
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 25px solid #6D28D9;
        }

        .shark-eye {
            position: absolute;
            left: 15px;
            top: 15px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
        }

        .shark-eye::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 6px;
            height: 6px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .shark-mouth {
            position: absolute;
            left: 5px;
            top: 30px;
            width: 25px;
            height: 10px;
            background: #DC2626;
            border-radius: 0 0 10px 10px;
        }

        .shark-teeth {
            position: absolute;
            left: 5px;
            top: 28px;
            display: flex;
            gap: 3px;
        }

        .shark-teeth span {
            width: 4px;
            height: 6px;
            background: white;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
        }

        .fish {
            position: absolute;
            display: none;
            z-index: 15;
            transition: all 0.3s ease;
        }

        .fish.small {
            width: 30px;
            height: 20px;
        }

        .fish.big {
            width: 60px;
            height: 40px;
        }

        .fish.visible {
            display: block;
            animation: fishBounce 0.5s ease-out;
        }

        @keyframes fishBounce {
            0% { transform: scale(0) rotate(-20deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(-10deg); }
        }

        .fish-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #FF6B6B 0%, #EE5A5A 100%);
            border-radius: 50% 30% 30% 50%;
            position: relative;
        }

        .fish.big .fish-body {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
        }

        .fish-tail {
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid #EE5A5A;
        }

        .fish.big .fish-tail {
            right: -15px;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 20px solid #FFA500;
        }

        .fish-eye {
            position: absolute;
            left: 5px;
            top: 5px;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .fish.big .fish-eye {
            left: 10px;
            top: 10px;
            width: 10px;
            height: 10px;
        }

        .fish-eye::after {
            content: '';
            position: absolute;
            left: 1px;
            top: 1px;
            width: 3px;
            height: 3px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .fish.big .fish-eye::after {
            left: 2px;
            top: 2px;
            width: 5px;
            height: 5px;
        }

        .trophy-area {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .trophy-title {
            font-size: 0.9em;
            color: #2C3E50;
            margin-bottom: 5px;
            text-align: center;
        }

        .medals {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-width: 120px;
            justify-content: center;
        }

        .medal {
            width: 25px;
            height: 30px;
            position: relative;
        }

        .medal-circle {
            width: 25px;
            height: 25px;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            color: #8B4513;
        }

        .medal-ribbon {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 10px;
            background: #DC2626;
            clip-path: polygon(0 0, 100% 0, 80% 100%, 50% 70%, 20% 100%);
        }

        .status-area {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            margin: 10px 0;
        }

        .level-display {
            font-size: 1.3em;
            color: #2C3E50;
            margin-bottom: 5px;
        }

        .instruction {
            font-size: 1.1em;
            color: #4A5568;
            min-height: 1.5em;
        }

        .strikes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .strike {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E2E8F0;
            border: 2px solid #CBD5E0;
        }

        .strike.active {
            background: #EF4444;
            border-color: #DC2626;
        }

        .piano-container {
            background: linear-gradient(180deg, #2C3E50 0%, #1a252f 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .piano {
            display: flex;
            justify-content: center;
            position: relative;
            height: 150px;
        }

        .white-key {
            width: 50px;
            height: 150px;
            background: linear-gradient(180deg, #FFFFFF 0%, #F0F0F0 90%, #D0D0D0 100%);
            border: 1px solid #ccc;
            border-radius: 0 0 8px 8px;
            margin: 0 2px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            transition: background 0.1s, transform 0.1s;
        }

        .white-key:active,
        .white-key.pressed {
            transform: translateY(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .white-key.highlight-C { background: linear-gradient(180deg, #FF6B6B 0%, #EE5A5A 90%, #CC4444 100%) !important; }
        .white-key.highlight-D { background: linear-gradient(180deg, #FFA500 0%, #FF8C00 90%, #CC7000 100%) !important; }
        .white-key.highlight-E { background: linear-gradient(180deg, #FFD700 0%, #FFC000 90%, #CCA000 100%) !important; }
        .white-key.highlight-F { background: linear-gradient(180deg, #4ADE80 0%, #22C55E 90%, #1A9A4A 100%) !important; }
        .white-key.highlight-G { background: linear-gradient(180deg, #60A5FA 0%, #3B82F6 90%, #2563EB 100%) !important; }
        .white-key.highlight-A { background: linear-gradient(180deg, #6366F1 0%, #4F46E5 90%, #3730A3 100%) !important; }
        .white-key.highlight-B { background: linear-gradient(180deg, #A855F7 0%, #9333EA 90%, #7E22CE 100%) !important; }

        .black-key {
            width: 30px;
            height: 90px;
            background: linear-gradient(180deg, #2C3E50 0%, #1a1a1a 100%);
            border-radius: 0 0 5px 5px;
            position: absolute;
            top: 0;
            cursor: pointer;
            z-index: 2;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            transition: background 0.1s, transform 0.1s;
        }

        .black-key:active,
        .black-key.pressed {
            transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .black-key.highlight {
            background: linear-gradient(180deg, #8B5CF6 0%, #6D28D9 100%) !important;
        }

        .note-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }

        .sequence-display {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: #E2E8F0;
            min-height: 1.5em;
        }

        .bubbles {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            pointer-events: none;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            bottom: -20px;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
            border-radius: 50%;
            animation: rise 3s ease-in infinite;
        }

        @keyframes rise {
            0% { bottom: -20px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { bottom: 100%; opacity: 0; }
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #FFD700, #FFA500);
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2em;
            color: #2C3E50;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            transition: transform 0.3s ease-out;
        }

        .success-message.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        .fail-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #FEE2E2, #FECACA);
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 1.5em;
            color: #991B1B;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            transition: transform 0.3s ease-out;
        }

        .fail-message.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .title {
                font-size: 1.8em;
            }

            .scene {
                height: 200px;
            }

            .piano {
                height: 120px;
            }

            .white-key {
                width: 40px;
                height: 120px;
            }

            .black-key {
                width: 24px;
                height: 70px;
            }

            .seal {
                width: 60px;
                height: 45px;
            }

            .seal-body {
                width: 60px;
                height: 38px;
            }

            .seal-head {
                width: 28px;
                height: 24px;
                right: -12px;
            }

            .ice-flow {
                width: 90px;
                height: 30px;
            }

            .control-group {
                padding: 5px 10px;
                font-size: 0.9em;
            }

            .btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .trophy-area {
                padding: 5px 10px;
            }

            .medal {
                width: 20px;
                height: 25px;
            }

            .medal-circle {
                width: 20px;
                height: 20px;
                font-size: 0.6em;
            }
        }

        @media (max-width: 480px) and (orientation: portrait) {
            .rotate-message {
                display: flex;
            }
        }

        .rotate-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2C3E50;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-size: 1.5em;
            text-align: center;
            padding: 20px;
        }

        .rotate-icon {
            font-size: 3em;
            margin-bottom: 20px;
            animation: rotateIcon 2s ease-in-out infinite;
        }

        @keyframes rotateIcon {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="rotate-message">
        <div class="rotate-icon">ðŸ“±</div>
        <div>Please rotate your device to landscape mode for the best experience!</div>
    </div>

    <div class="game-container">
        <div class="header">
            <h1 class="title">Dunk the Baby Seal Pup</h1>
            <div class="controls">
                <div class="control-group">
                    <label>Level:</label>
                    <select id="levelSelect">
                        <option value="0">1 - Hot Cross Buns</option>
                        <option value="1">2 - Mary Had a Little Lamb</option>
                        <option value="2">3 - Twinkle Twinkle</option>
                        <option value="3">4 - Row Your Boat</option>
                        <option value="4">5 - Uptown Funk</option>
                        <option value="5">6 - London Bridge</option>
                        <option value="6">7 - Jingle Bells</option>
                        <option value="7">8 - Ode to Joy</option>
                        <option value="8">9 - Happy Birthday</option>
                        <option value="9">10 - When the Saints</option>
                        <option value="10">11 - Fur Elise</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Speed:</label>
                    <select id="speedSelect">
                        <option value="slow">Slow</option>
                        <option value="normal" selected>Normal</option>
                        <option value="fast">Fast</option>
                    </select>
                </div>
                <button class="btn btn-start" id="startBtn">Start</button>
                <button class="btn btn-retry" id="retryBtn" style="display: none;">Retry</button>
            </div>
        </div>

        <div class="game-area">
            <div class="scene">
                <div class="water">
                    <div class="bubbles" id="bubbles"></div>
                </div>
                <div class="ice-flow"></div>
                <div class="seal" id="seal">
                    <div class="seal-body">
                        <div class="seal-head">
                            <div class="seal-eye"></div>
                            <div class="seal-nose"></div>
                            <div class="seal-whiskers"></div>
                        </div>
                        <div class="seal-flipper"></div>
                        <div class="seal-tail"></div>
                        <div class="bandaid" id="bandaid"></div>
                    </div>
                    <!-- Fish now inside seal container so they follow -->
                    <div class="fish small" id="smallFish" style="top: -10px; left: 70px;">
                        <div class="fish-body">
                            <div class="fish-tail"></div>
                            <div class="fish-eye"></div>
                        </div>
                    </div>
                    <div class="fish big" id="bigFish" style="top: -25px; left: 60px;">
                        <div class="fish-body">
                            <div class="fish-tail"></div>
                            <div class="fish-eye"></div>
                        </div>
                    </div>
                </div>
                <div class="shark" id="shark">
                    <div class="shark-body">
                        <div class="shark-fin"></div>
                        <div class="shark-tail"></div>
                        <div class="shark-eye"></div>
                        <div class="shark-mouth"></div>
                        <div class="shark-teeth">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
                <div class="trophy-area">
                    <div class="trophy-title">Medals</div>
                    <div class="medals" id="medals"></div>
                </div>
            </div>

            <div class="status-area">
                <div class="level-display" id="levelDisplay">Level 1: Hot Cross Buns</div>
                <div class="instruction" id="instruction">Press Start to begin!</div>
                <div class="strikes">
                    <div class="strike" id="strike1"></div>
                    <div class="strike" id="strike2"></div>
                    <div class="strike" id="strike3"></div>
                </div>
            </div>

            <div class="piano-container">
                <div class="piano" id="piano"></div>
                <div class="sequence-display" id="sequenceDisplay"></div>
            </div>
        </div>
    </div>

    <div class="success-message" id="successMessage">
        <div>Level Complete!</div>
        <div style="font-size: 0.6em; margin-top: 10px;">You earned a gold medal!</div>
    </div>

    <div class="fail-message" id="failMessage">
        <div>Oops! Try again!</div>
        <div style="font-size: 0.6em; margin-top: 10px;">The seal got a little nibble...</div>
    </div>

    <script>
        // Audio Context for piano sounds
        let audioContext;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Resume if suspended (needed for some browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Note frequencies (extended range for Fur Elise)
        const noteFrequencies = {
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
            'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88
        };

        // Rainbow colors for white keys
        const keyColors = {
            'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'A': 'A', 'B': 'B'
        };

        // Play piano-like sound
        function playNote(note, duration = 0.5) {
            initAudio();
            const freq = noteFrequencies[note];
            if (!freq) return;

            const now = audioContext.currentTime;

            // Create oscillators for richer piano-like sound
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();

            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            // Setup filter for piano-like warmth
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(2000, now);
            filter.frequency.exponentialRampToValueAtTime(500, now + duration);

            // Main tone
            osc1.type = 'triangle';
            osc1.frequency.setValueAtTime(freq, now);

            // Harmonic overtones
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(freq * 2, now);

            osc3.type = 'sine';
            osc3.frequency.setValueAtTime(freq * 3, now);

            // Gain envelope (piano-like attack and decay)
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01); // Quick attack
            gainNode.gain.exponentialRampToValueAtTime(0.2, now + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);

            // Connect nodes
            const osc1Gain = audioContext.createGain();
            const osc2Gain = audioContext.createGain();
            const osc3Gain = audioContext.createGain();

            osc1Gain.gain.value = 0.5;
            osc2Gain.gain.value = 0.2;
            osc3Gain.gain.value = 0.1;

            osc1.connect(osc1Gain);
            osc2.connect(osc2Gain);
            osc3.connect(osc3Gain);

            osc1Gain.connect(filter);
            osc2Gain.connect(filter);
            osc3Gain.connect(filter);

            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc1.start(now);
            osc2.start(now);
            osc3.start(now);

            osc1.stop(now + duration);
            osc2.stop(now + duration);
            osc3.stop(now + duration);
        }

        // Song definitions
        const songs = [
            {
                name: "Hot Cross Buns",
                notes: ['E4', 'D4', 'C4', 'E4', 'D4', 'C4', 'C4', 'C4', 'C4', 'C4', 'D4', 'D4', 'D4', 'D4', 'E4', 'D4', 'C4']
            },
            {
                name: "Mary Had a Little Lamb",
                notes: ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4', 'D4', 'D4', 'D4', 'E4', 'G4', 'G4']
            },
            {
                name: "Twinkle Twinkle",
                notes: ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4']
            },
            {
                name: "Row Your Boat",
                notes: ['C4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'E4', 'F4', 'G4']
            },
            {
                name: "Uptown Funk",
                notes: ['G4', 'G4', 'G4', 'G4', 'E4', 'G4', 'G4', 'G4', 'A4', 'G4', 'E4', 'D4']
            },
            {
                name: "London Bridge",
                notes: ['G4', 'A4', 'G4', 'F4', 'E4', 'F4', 'G4', 'D4', 'E4', 'F4', 'E4', 'F4', 'G4']
            },
            {
                name: "Jingle Bells",
                notes: ['E4', 'E4', 'E4', 'E4', 'E4', 'E4', 'E4', 'G4', 'C4', 'D4', 'E4', 'F4', 'F4', 'F4', 'F4']
            },
            {
                name: "Ode to Joy",
                notes: ['E4', 'E4', 'F4', 'G4', 'G4', 'F4', 'E4', 'D4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'D4']
            },
            {
                name: "Happy Birthday",
                notes: ['C4', 'C4', 'D4', 'C4', 'F4', 'E4', 'C4', 'C4', 'D4', 'C4', 'G4', 'F4', 'C4', 'C4', 'A4', 'F4', 'E4', 'D4']
            },
            {
                name: "When the Saints",
                notes: ['C4', 'E4', 'F4', 'G4', 'C4', 'E4', 'F4', 'G4', 'C4', 'E4', 'F4', 'G4', 'E4', 'C4', 'E4', 'D4']
            },
            {
                name: "Fur Elise",
                // Simplified to use only one octave (no D#4 issues - it's a black key that's supported)
                notes: ['E4', 'D#4', 'E4', 'D#4', 'E4', 'B4', 'D4', 'C4', 'A4', 'C4', 'E4', 'A4', 'B4', 'E4', 'G#4', 'B4', 'C4']
            }
        ];

        // Game state
        let currentLevel = 0;
        let currentSequenceIndex = 0;
        let playerSequence = [];
        let isPlaying = false;
        let isWaitingForInput = false; // New flag to track when player can input
        let strikes = 0;
        let completedLevels = [];
        let speed = 'normal';
        let gameStarted = false;
        let pressedKeys = new Set(); // Track pressed keyboard keys to prevent repeat

        // Speed multipliers
        const speedMultipliers = {
            slow: 1.67,
            normal: 1,
            fast: 0.67
        };

        // DOM elements
        const seal = document.getElementById('seal');
        const shark = document.getElementById('shark');
        const bandaid = document.getElementById('bandaid');
        const smallFish = document.getElementById('smallFish');
        const bigFish = document.getElementById('bigFish');
        const medals = document.getElementById('medals');
        const levelDisplay = document.getElementById('levelDisplay');
        const instruction = document.getElementById('instruction');
        const sequenceDisplay = document.getElementById('sequenceDisplay');
        const startBtn = document.getElementById('startBtn');
        const retryBtn = document.getElementById('retryBtn');
        const levelSelect = document.getElementById('levelSelect');
        const speedSelect = document.getElementById('speedSelect');
        const successMessage = document.getElementById('successMessage');
        const failMessage = document.getElementById('failMessage');
        const piano = document.getElementById('piano');
        const strikeElements = [
            document.getElementById('strike1'),
            document.getElementById('strike2'),
            document.getElementById('strike3')
        ];

        // Build piano dynamically
        function buildPiano() {
            const whiteNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
            const blackNotes = [
                { note: 'C#4', position: 0 },
                { note: 'D#4', position: 1 },
                { note: 'F#4', position: 3 },
                { note: 'G#4', position: 4 },
                { note: 'A#4', position: 5 }
            ];

            // Create white keys
            whiteNotes.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'white-key';
                key.dataset.note = note;
                key.dataset.index = index;

                const label = document.createElement('span');
                label.className = 'note-label';
                label.textContent = note.replace('4', '');
                key.appendChild(label);

                piano.appendChild(key);
            });

            // Create black keys (positioned after white keys are in DOM)
            blackNotes.forEach(({ note, position }) => {
                const key = document.createElement('div');
                key.className = 'black-key';
                key.dataset.note = note;
                key.dataset.position = position;
                piano.appendChild(key);
            });

            // Position black keys after layout
            requestAnimationFrame(() => {
                positionBlackKeys();
            });
        }

        // Position black keys relative to white keys
        function positionBlackKeys() {
            const whiteKeys = piano.querySelectorAll('.white-key');
            const blackKeys = piano.querySelectorAll('.black-key');

            blackKeys.forEach(blackKey => {
                const position = parseInt(blackKey.dataset.position);
                const whiteKey = whiteKeys[position];
                if (whiteKey) {
                    const whiteRect = whiteKey.getBoundingClientRect();
                    const pianoRect = piano.getBoundingClientRect();
                    const blackKeyWidth = blackKey.offsetWidth;

                    // Position at the right edge of the white key, minus half the black key width
                    const leftPos = (whiteRect.right - pianoRect.left) - (blackKeyWidth / 2) - 2;
                    blackKey.style.left = leftPos + 'px';
                }
            });
        }

        // Reposition on resize
        window.addEventListener('resize', () => {
            requestAnimationFrame(positionBlackKeys);
        });

        // Create bubbles
        function createBubbles() {
            const bubblesContainer = document.getElementById('bubbles');
            for (let i = 0; i < 10; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.animationDelay = Math.random() * 3 + 's';
                bubble.style.width = (Math.random() * 10 + 5) + 'px';
                bubble.style.height = bubble.style.width;
                bubblesContainer.appendChild(bubble);
            }
        }

        // Update medals display
        function updateMedals() {
            medals.innerHTML = '';
            // Sort completed levels for display
            const sortedLevels = [...completedLevels].sort((a, b) => a - b);
            sortedLevels.forEach((level) => {
                const medal = document.createElement('div');
                medal.className = 'medal';
                medal.innerHTML = `
                    <div class="medal-circle">${level + 1}</div>
                    <div class="medal-ribbon"></div>
                `;
                medals.appendChild(medal);
            });
        }

        // Update strikes display
        function updateStrikes() {
            strikeElements.forEach((el, i) => {
                el.classList.toggle('active', i < strikes);
            });
        }

        // Highlight key - fixed to properly extract note name
        function highlightKey(note, duration = 500) {
            const key = document.querySelector(`[data-note="${note}"]`);
            if (key) {
                const isBlack = note.includes('#');

                if (isBlack) {
                    key.classList.add('highlight');
                } else {
                    // Extract just the letter (C, D, E, etc.) from notes like "C4"
                    const noteLetter = note.charAt(0);
                    key.classList.add(`highlight-${noteLetter}`);
                }
                key.classList.add('pressed');

                setTimeout(() => {
                    if (isBlack) {
                        key.classList.remove('highlight');
                    } else {
                        const noteLetter = note.charAt(0);
                        key.classList.remove(`highlight-${noteLetter}`);
                    }
                    key.classList.remove('pressed');
                }, duration);
            }
        }

        // Play sequence
        async function playSequence(sequence) {
            const multiplier = speedMultipliers[speed];
            const noteDelay = 600 * multiplier;

            for (let i = 0; i < sequence.length; i++) {
                // Check if game was interrupted
                if (!isPlaying) return;

                const note = sequence[i];
                playNote(note, 0.4 * multiplier);
                highlightKey(note, 400 * multiplier);
                await new Promise(resolve => setTimeout(resolve, noteDelay));
            }
        }

        // Seal animations - fixed to clear all states properly
        function sealDive() {
            seal.classList.remove('returning', 'swimming', 'diving');
            // Force reflow
            void seal.offsetWidth;
            seal.classList.add('diving');
            setTimeout(() => {
                if (seal.classList.contains('diving')) {
                    seal.classList.remove('diving');
                    seal.classList.add('swimming');
                }
            }, 800);
        }

        function sealReturn(withBigFish = false) {
            seal.classList.remove('swimming', 'diving');
            seal.classList.add('returning');

            // Hide both fish first
            smallFish.classList.remove('visible');
            bigFish.classList.remove('visible');

            // Show appropriate fish after a small delay for seal to start returning
            setTimeout(() => {
                if (withBigFish) {
                    bigFish.classList.add('visible');
                    setTimeout(() => bigFish.classList.remove('visible'), 2500);
                } else {
                    smallFish.classList.add('visible');
                    setTimeout(() => smallFish.classList.remove('visible'), 2000);
                }
            }, 400);
        }

        // Reset seal to initial state
        function resetSeal() {
            seal.classList.remove('swimming', 'diving', 'returning');
            smallFish.classList.remove('visible');
            bigFish.classList.remove('visible');
        }

        // Shark attack
        async function sharkAttack() {
            shark.classList.add('attacking');
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Show bandaid
            bandaid.classList.add('visible');

            await new Promise(resolve => setTimeout(resolve, 500));
            shark.classList.remove('attacking');

            // Return seal to ice
            sealReturn(false);

            // Show fail message
            failMessage.classList.add('visible');
            setTimeout(() => failMessage.classList.remove('visible'), 2000);
        }

        // Start game
        async function startGame() {
            initAudio();
            gameStarted = true;
            isPlaying = true;
            isWaitingForInput = false;
            strikes = 0;
            currentSequenceIndex = 0;
            playerSequence = [];
            bandaid.classList.remove('visible');
            resetSeal();

            updateStrikes();

            startBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            levelSelect.disabled = true;
            speedSelect.disabled = true;

            const song = songs[currentLevel];
            levelDisplay.textContent = `Level ${currentLevel + 1}: ${song.name}`;
            instruction.textContent = 'Watch and listen...';
            sequenceDisplay.textContent = '';

            // Seal dives
            sealDive();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Play first note sequence
            await playNextSequence();
        }

        // Play next sequence in Simon Says style
        async function playNextSequence() {
            if (!isPlaying) return;

            const song = songs[currentLevel];
            currentSequenceIndex++;

            if (currentSequenceIndex > song.notes.length) {
                // Level complete!
                await levelComplete();
                return;
            }

            isWaitingForInput = false;
            const sequence = song.notes.slice(0, currentSequenceIndex);
            instruction.textContent = `Listen to ${currentSequenceIndex} note${currentSequenceIndex > 1 ? 's' : ''}...`;
            sequenceDisplay.textContent = '';

            await new Promise(resolve => setTimeout(resolve, 500));

            if (!isPlaying) return;

            await playSequence(sequence);

            if (!isPlaying) return;

            instruction.textContent = 'Your turn! Play the notes.';
            playerSequence = [];
            sequenceDisplay.textContent = `Notes: 0/${currentSequenceIndex}`;
            isWaitingForInput = true;
        }

        // Handle key press
        function handleKeyPress(note) {
            // Only accept input when waiting for it
            if (!isPlaying || !isWaitingForInput || currentSequenceIndex === 0) return;

            const song = songs[currentLevel];
            const expectedNote = song.notes[playerSequence.length];

            playNote(note, 0.3);
            highlightKey(note, 300);

            playerSequence.push(note);
            sequenceDisplay.textContent = `Notes: ${playerSequence.length}/${currentSequenceIndex}`;

            if (note !== expectedNote) {
                // Wrong note!
                isWaitingForInput = false;
                handleMistake();
            } else if (playerSequence.length === currentSequenceIndex) {
                // Correct sequence!
                isWaitingForInput = false;
                setTimeout(() => playNextSequence(), 500);
            }
        }

        // Handle mistake
        async function handleMistake() {
            strikes++;
            updateStrikes();
            playerSequence = [];

            if (strikes >= 3) {
                // Shark attack!
                isPlaying = false;
                isWaitingForInput = false;
                await sharkAttack();
                strikes = 0;
                updateStrikes();

                setTimeout(() => {
                    retryBtn.style.display = 'inline-block';
                    levelSelect.disabled = false;
                    speedSelect.disabled = false;
                    instruction.textContent = 'Oh no! The shark got you! Try again?';
                }, 2500);
            } else {
                // Just return with small fish
                sealReturn(false);
                instruction.textContent = `Oops! Wrong note. ${3 - strikes} tries left. Watch again...`;

                setTimeout(async () => {
                    if (!isPlaying) return;

                    sealDive();
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (!isPlaying) return;

                    const sequence = songs[currentLevel].notes.slice(0, currentSequenceIndex);
                    instruction.textContent = `Listen to ${currentSequenceIndex} note${currentSequenceIndex > 1 ? 's' : ''}...`;

                    await playSequence(sequence);

                    if (!isPlaying) return;

                    instruction.textContent = 'Your turn! Play the notes.';
                    playerSequence = [];
                    sequenceDisplay.textContent = `Notes: 0/${currentSequenceIndex}`;
                    isWaitingForInput = true;
                }, 2000);
            }
        }

        // Level complete
        async function levelComplete() {
            isPlaying = false;
            isWaitingForInput = false;

            // Seal returns with big fish
            sealReturn(true);

            // Add medal if not already completed
            if (!completedLevels.includes(currentLevel)) {
                completedLevels.push(currentLevel);
                updateMedals();
            }

            // Show success message
            successMessage.classList.add('visible');

            await new Promise(resolve => setTimeout(resolve, 3000));
            successMessage.classList.remove('visible');

            // Check if there's a next level
            if (currentLevel < songs.length - 1) {
                currentLevel++;
                levelSelect.value = currentLevel;
                instruction.textContent = `Great job! Ready for Level ${currentLevel + 1}?`;
                startBtn.textContent = 'Next Level';
            } else {
                instruction.textContent = 'Congratulations! You completed all levels!';
                startBtn.textContent = 'Play Again';
                currentLevel = 0; // Reset to first level for "Play Again"
                levelSelect.value = currentLevel;
            }

            startBtn.style.display = 'inline-block';
            levelSelect.disabled = false;
            speedSelect.disabled = false;
            sequenceDisplay.textContent = '';
        }

        // Retry level
        function retryLevel() {
            retryBtn.style.display = 'none';
            currentSequenceIndex = 0;
            resetSeal();
            startGame();
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            currentLevel = parseInt(levelSelect.value);
            currentSequenceIndex = 0;
            startBtn.textContent = 'Start';
            startGame();
        });

        retryBtn.addEventListener('click', retryLevel);

        levelSelect.addEventListener('change', (e) => {
            currentLevel = parseInt(e.target.value);
            const song = songs[currentLevel];
            levelDisplay.textContent = `Level ${currentLevel + 1}: ${song.name}`;
            instruction.textContent = 'Press Start to begin!';
            startBtn.textContent = 'Start';
        });

        speedSelect.addEventListener('change', (e) => {
            speed = e.target.value;
        });

        // Piano key events - improved touch handling
        piano.addEventListener('mousedown', (e) => {
            const key = e.target.closest('.white-key, .black-key');
            if (key && key.dataset.note) {
                handleKeyPress(key.dataset.note);
            }
        });

        piano.addEventListener('touchstart', (e) => {
            e.preventDefault();

            Array.from(e.touches).forEach(touch => {
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                const key = element ? element.closest('.white-key, .black-key') : null;
                if (key && key.dataset.note) {
                    handleKeyPress(key.dataset.note);
                }
            });
        }, { passive: false });

        // Keyboard support with repeat prevention
        const keyboardMap = {
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
            'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
            'u': 'A#4', 'j': 'B4'
        };

        document.addEventListener('keydown', (e) => {
            // Prevent key repeat
            if (e.repeat) return;

            const keyLower = e.key.toLowerCase();

            // Track pressed keys
            if (pressedKeys.has(keyLower)) return;
            pressedKeys.add(keyLower);

            if (!gameStarted) {
                initAudio();
            }

            const note = keyboardMap[keyLower];
            if (note) {
                handleKeyPress(note);
            }
        });

        document.addEventListener('keyup', (e) => {
            pressedKeys.delete(e.key.toLowerCase());
        });

        // Initialize
        buildPiano();
        createBubbles();
        updateMedals();
        updateStrikes();
    </script>
</body>
</html>
