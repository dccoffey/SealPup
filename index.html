<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fishing with Pup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', cursive;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #1E90FF 50%, #0066AA 100%);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 5px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 5px;
        }

        .title {
            font-size: 1.8em;
            color: #2C3E50;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .scene {
            position: relative;
            height: 180px;
            min-height: 180px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 60%, transparent 60%);
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(180deg, #4AA3DF 0%, #1E5F8A 100%);
        }

        .ice-flow {
            position: absolute;
            bottom: 55%;
            left: 8%;
            width: 110px;
            height: 40px;
            background: linear-gradient(180deg, #FFFFFF 0%, #E8F4F8 40%, #C5E3F0 70%, #A8D4E8 100%);
            clip-path: polygon(5% 100%, 0% 60%, 8% 30%, 20% 0%, 35% 15%, 50% 5%, 65% 20%, 80% 0%, 92% 25%, 100% 50%, 95% 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .reward-fish-container {
            position: absolute;
            bottom: 58%;
            left: 12%;
            display: flex;
            gap: 2px;
            z-index: 5;
        }

        .reward-fish {
            width: 18px;
            height: 12px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease-out;
        }

        .reward-fish.visible {
            opacity: 1;
            transform: scale(1);
        }

        .reward-fish .fish-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #FF6B6B 0%, #EE5A5A 100%);
            border-radius: 50% 30% 30% 50%;
            position: relative;
        }

        .reward-fish:nth-child(2n) .fish-body {
            background: linear-gradient(180deg, #4ECDC4 0%, #26A69A 100%);
        }

        .reward-fish:nth-child(3n) .fish-body {
            background: linear-gradient(180deg, #FFD93D 0%, #F4B400 100%);
        }

        .reward-fish .fish-tail {
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 6px solid #EE5A5A;
        }

        .reward-fish:nth-child(2n) .fish-tail {
            border-left-color: #26A69A;
        }

        .reward-fish:nth-child(3n) .fish-tail {
            border-left-color: #F4B400;
        }

        .reward-fish .fish-eye {
            position: absolute;
            left: 3px;
            top: 3px;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
        }

        .seal {
            position: absolute;
            bottom: 58%;
            left: 10%;
            width: 90px;
            height: 70px;
            transition: all 0.8s ease-in-out;
            z-index: 10;
        }

        .seal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1); /* Flip horizontally so seal faces right */
        }

        .seal.diving {
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
        }

        .seal.swimming {
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%);
            animation: swim 2s ease-in-out infinite;
        }

        .seal.returning {
            bottom: 58%;
            left: 10%;
            transform: none;
            animation: none;
        }

        @keyframes swim {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .bandaid {
            position: absolute;
            top: 35px;
            left: 25px;
            width: 28px;
            height: 12px;
            background: #FFD5B5;
            border-radius: 3px;
            display: none;
            z-index: 15;
        }

        .bandaid::before,
        .bandaid::after {
            content: '';
            position: absolute;
            top: 2px;
            width: 5px;
            height: 8px;
            background: #E8C4A8;
            border-radius: 1px;
        }

        .bandaid::before { left: 4px; }
        .bandaid::after { right: 4px; }

        .bandaid.visible {
            display: block;
        }

        .shark {
            position: absolute;
            bottom: 10%;
            right: -150px;
            width: 120px;
            height: 80px;
            transition: right 1s ease-in-out;
            z-index: 5;
        }

        .shark.attacking {
            right: 35%;
        }

        .shark-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .fish {
            position: absolute;
            display: none;
            z-index: 15;
            transition: all 0.3s ease;
        }

        .fish.small {
            width: 25px;
            height: 17px;
        }

        .fish.visible {
            display: block;
            animation: fishBounce 0.5s ease-out;
        }

        @keyframes fishBounce {
            0% { transform: scale(0) rotate(-20deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(-10deg); }
        }

        .fish-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #FF6B6B 0%, #EE5A5A 100%);
            border-radius: 50% 30% 30% 50%;
            position: relative;
        }

        .fish-tail {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 10px solid #EE5A5A;
        }

        .fish-eye {
            position: absolute;
            left: 4px;
            top: 4px;
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
        }

        .fish-eye::after {
            content: '';
            position: absolute;
            left: 1px;
            top: 1px;
            width: 2px;
            height: 2px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .trophy-area {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .trophy-title {
            font-size: 0.75em;
            color: #2C3E50;
            margin-bottom: 3px;
            text-align: center;
        }

        .medals {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            max-width: 100px;
            justify-content: center;
        }

        .medal {
            width: 20px;
            height: 24px;
            position: relative;
        }

        .medal-circle {
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            font-weight: bold;
            color: #8B4513;
        }

        .medal-ribbon {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 8px;
            background: #DC2626;
            clip-path: polygon(0 0, 100% 0, 80% 100%, 50% 70%, 20% 100%);
        }

        .status-area {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            margin: 5px 0;
        }

        .level-display {
            font-size: 1.1em;
            color: #2C3E50;
            margin-bottom: 3px;
        }

        .instruction {
            font-size: 1em;
            color: #4A5568;
            min-height: 1.3em;
        }

        .strikes {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }

        .strike {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #E2E8F0;
            border: 2px solid #CBD5E0;
        }

        .strike.active {
            background: #EF4444;
            border-color: #DC2626;
        }

        .piano-container {
            background: linear-gradient(180deg, #2C3E50 0%, #1a252f 100%);
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .piano {
            display: flex;
            justify-content: center;
            position: relative;
            flex: 1;
            min-height: 100px;
        }

        .white-key {
            flex: 1;
            max-width: 80px;
            background: linear-gradient(180deg, #E8E8E8 0%, #DCDCDC 90%, #C0C0C0 100%);
            border: 1px solid #bbb;
            border-radius: 0 0 8px 8px;
            margin: 0 2px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.1s, border-color 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }

        .piano.ready .white-key {
            background: linear-gradient(180deg, #FFFFFF 0%, #F0F0F0 90%, #D0D0D0 100%);
            border-color: #ccc;
        }

        .white-key:active,
        .white-key.pressed {
            transform: translateY(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .white-key.disabled {
            pointer-events: none;
        }

        .white-key.highlight-C { background: linear-gradient(180deg, #FF6B6B 0%, #EE5A5A 90%, #CC4444 100%) !important; }
        .white-key.highlight-D { background: linear-gradient(180deg, #FFA500 0%, #FF8C00 90%, #CC7000 100%) !important; }
        .white-key.highlight-E { background: linear-gradient(180deg, #FFD700 0%, #FFC000 90%, #CCA000 100%) !important; }
        .white-key.highlight-F { background: linear-gradient(180deg, #4ADE80 0%, #22C55E 90%, #1A9A4A 100%) !important; }
        .white-key.highlight-G { background: linear-gradient(180deg, #60A5FA 0%, #3B82F6 90%, #2563EB 100%) !important; }
        .white-key.highlight-A { background: linear-gradient(180deg, #6366F1 0%, #4F46E5 90%, #3730A3 100%) !important; }

        .black-key {
            width: 28px;
            height: 45%;
            background: linear-gradient(180deg, #2C3E50 0%, #1a1a1a 100%);
            border-radius: 0 0 5px 5px;
            position: absolute;
            top: 0;
            cursor: pointer;
            z-index: 2;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            transition: background 0.1s, transform 0.1s;
        }

        .black-key:active,
        .black-key.pressed {
            transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .black-key.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .black-key.highlight {
            background: linear-gradient(180deg, #8B5CF6 0%, #6D28D9 100%) !important;
        }

        .note-label {
            font-size: 1.2em;
            color: #666;
            font-weight: bold;
        }

        .sequence-display {
            text-align: center;
            padding: 5px;
            font-size: 1em;
            color: #E2E8F0;
            min-height: 1.3em;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            margin-top: 5px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .control-group label {
            font-weight: bold;
            color: #2C3E50;
            font-size: 0.85em;
        }

        select {
            padding: 4px 8px;
            border-radius: 8px;
            border: 2px solid #2C3E50;
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            font-size: 1em;
            font-family: inherit;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            font-weight: bold;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-start {
            background: #1a1a1a;
            color: white;
            box-shadow: 0 3px 0 #000;
        }

        .btn-retry {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: #2C3E50;
            box-shadow: 0 3px 0 #B8860B;
        }

        .btn-reset {
            background: linear-gradient(145deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 3px 0 #991B1B;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .bubbles {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            pointer-events: none;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            bottom: -20px;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
            border-radius: 50%;
            animation: rise 3s ease-in infinite;
        }

        @keyframes rise {
            0% { bottom: -20px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { bottom: 100%; opacity: 0; }
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #FFD700, #FFA500);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.5em;
            color: #2C3E50;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            transition: transform 0.3s ease-out;
        }

        .success-message.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        .fail-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #FEE2E2, #FECACA);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.2em;
            color: #991B1B;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            transition: transform 0.3s ease-out;
        }

        .fail-message.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        @media (max-width: 480px) and (orientation: portrait) {
            .rotate-message {
                display: flex;
            }
        }

        .rotate-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2C3E50;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-size: 1.3em;
            text-align: center;
            padding: 20px;
        }

        .rotate-icon {
            font-size: 3em;
            margin-bottom: 20px;
            animation: rotateIcon 2s ease-in-out infinite;
        }

        @keyframes rotateIcon {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="rotate-message">
        <div class="rotate-icon">ðŸ“±</div>
        <div>Please rotate your device to landscape mode!</div>
    </div>

    <div class="game-container">
        <div class="header">
            <h1 class="title">Fishing with Pup</h1>
        </div>

        <div class="game-area">
            <div class="scene">
                <div class="water">
                    <div class="bubbles" id="bubbles"></div>
                </div>
                <div class="ice-flow"></div>
                <div class="reward-fish-container" id="rewardFishContainer"></div>
                <div class="seal" id="seal">
                    <img src="seal.png" alt="Seal Pup" class="seal-image">
                    <div class="bandaid" id="bandaid"></div>
                    <div class="fish small" id="smallFish" style="top: -8px; left: 70px;">
                        <div class="fish-body">
                            <div class="fish-tail"></div>
                            <div class="fish-eye"></div>
                        </div>
                    </div>
                </div>
                <div class="shark" id="shark">
                    <img src="orca.png" alt="Orca" class="shark-image">
                </div>
                <div class="trophy-area">
                    <div class="trophy-title">Medals</div>
                    <div class="medals" id="medals"></div>
                </div>
            </div>

            <div class="piano-container">
                <div class="piano" id="piano"></div>
                <div class="sequence-display" id="sequenceDisplay"></div>
            </div>

            <div class="status-area">
                <div class="level-display" id="levelDisplay">Hot Cross Buns (12 notes)</div>
                <div class="instruction" id="instruction">Press Start to begin!</div>
                <div class="strikes">
                    <div class="strike" id="strike1"></div>
                    <div class="strike" id="strike2"></div>
                    <div class="strike" id="strike3"></div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Song:</label>
                    <select id="levelSelect"></select>
                </div>
                <div class="control-group">
                    <label>Difficulty:</label>
                    <select id="difficultySelect">
                        <option value="supereasy">Super Easy (3)</option>
                        <option value="easy">Easy (6)</option>
                        <option value="medium" selected>Medium (12)</option>
                        <option value="hard">Hard (Full)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Speed:</label>
                    <select id="speedSelect">
                        <option value="slow">Slow</option>
                        <option value="normal" selected>Normal</option>
                        <option value="fast">Fast</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Start:</label>
                    <select id="startNotesSelect">
                        <option value="1">1 note</option>
                        <option value="2">2 notes</option>
                        <option value="3" selected>3 notes</option>
                        <option value="4">4 notes</option>
                        <option value="5">5 notes</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Add:</label>
                    <select id="addNotesSelect">
                        <option value="1">+1 note</option>
                        <option value="2" selected>+2 notes</option>
                        <option value="3">+3 notes</option>
                        <option value="phrase">+phrase</option>
                    </select>
                </div>
                <button class="btn btn-start" id="startBtn">Start</button>
                <button class="btn btn-retry" id="retryBtn" style="display: none;">Retry</button>
                <button class="btn btn-reset" id="resetBtn" style="display: none;">Reset</button>
            </div>
        </div>
    </div>

    <div class="success-message" id="successMessage">
        <div>Level Complete!</div>
        <div style="font-size: 0.6em; margin-top: 10px;">You earned a gold medal!</div>
    </div>

    <div class="fail-message" id="failMessage">
        <div>Oops! Try again!</div>
        <div style="font-size: 0.6em; margin-top: 10px;">The seal got a little nibble...</div>
    </div>

    <script>
        // Audio Context for piano sounds
        let audioContext;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Note frequencies (6 white keys: C D E F G A - removed B)
        const noteFrequencies = {
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
            'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00
        };

        // Play piano-like sound
        function playNote(note, duration = 0.5) {
            initAudio();
            const freq = noteFrequencies[note];
            if (!freq) return;

            const now = audioContext.currentTime;

            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();

            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(2000, now);
            filter.frequency.exponentialRampToValueAtTime(500, now + duration);

            osc1.type = 'triangle';
            osc1.frequency.setValueAtTime(freq, now);

            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(freq * 2, now);

            osc3.type = 'sine';
            osc3.frequency.setValueAtTime(freq * 3, now);

            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.2, now + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);

            const osc1Gain = audioContext.createGain();
            const osc2Gain = audioContext.createGain();
            const osc3Gain = audioContext.createGain();

            osc1Gain.gain.value = 0.5;
            osc2Gain.gain.value = 0.2;
            osc3Gain.gain.value = 0.1;

            osc1.connect(osc1Gain);
            osc2.connect(osc2Gain);
            osc3.connect(osc3Gain);

            osc1Gain.connect(filter);
            osc2Gain.connect(filter);
            osc3Gain.connect(filter);

            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc1.start(now);
            osc2.start(now);
            osc3.start(now);

            osc1.stop(now + duration);
            osc2.stop(now + duration);
            osc3.stop(now + duration);
        }

        // Song definitions with rhythm (timing in beats, where 1 = quarter note)
        // phrases: array of cumulative note counts where each phrase ends
        // Removed songs that use B or A#
        const songs = [
            {
                name: "Hot Cross Buns",
                notes: ['E4', 'D4', 'C4', 'E4', 'D4', 'C4', 'C4', 'C4', 'C4', 'C4', 'D4', 'D4', 'D4', 'D4', 'E4', 'D4', 'C4'],
                rhythm: [1, 1, 2, 1, 1, 2, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1, 1, 2],
                phrases: [3, 6, 10, 14, 17], // "Hot cross buns" | "Hot cross buns" | "One a penny" | "Two a penny" | "Hot cross buns"
                usesBlackKeys: false
            },
            {
                name: "Mary Had a Little Lamb",
                notes: ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4', 'D4', 'D4', 'D4', 'E4', 'G4', 'G4'],
                rhythm: [1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2],
                phrases: [4, 7, 10, 13], // "Mary had a" | "little lamb" | "little lamb" | "little lamb"
                usesBlackKeys: false
            },
            {
                name: "Twinkle Twinkle",
                notes: ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4'],
                rhythm: [1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 2],
                phrases: [2, 4, 7, 9, 11, 14], // "Twinkle" | "twinkle" | "little star" | "how I" | "wonder" | "what you are"
                usesBlackKeys: false
            },
            {
                name: "Row Your Boat",
                notes: ['C4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'E4', 'F4', 'G4'],
                rhythm: [1, 1, 0.75, 0.25, 1, 0.75, 0.25, 0.75, 0.25, 2],
                phrases: [3, 5, 7, 10], // "Row row row" | "your boat" | "gently down" | "the stream"
                usesBlackKeys: false
            },
            {
                name: "Uptown Funk",
                notes: ['D4', 'F4', 'E4', 'D4', 'C4', 'D4', 'E4', 'F4', 'E4', 'D4', 'D4', 'F4', 'E4', 'D4'],
                rhythm: [0.5, 1, 0.5, 0.5, 0.5, 0.5, 0.5, 1, 0.5, 1, 0.5, 1, 0.5, 1],
                phrases: [2, 4, 7, 10, 14], // "I'm too" | "hot (hot)" | "call the police" | "and the fireman" | "I'm too hot"
                usesBlackKeys: false
            },
            {
                name: "London Bridge",
                notes: ['G4', 'A4', 'G4', 'F4', 'E4', 'F4', 'G4', 'D4', 'E4', 'F4', 'E4', 'F4', 'G4'],
                rhythm: [1.5, 0.5, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2],
                phrases: [4, 7, 10, 13], // "London Bridge is" | "falling down" | "falling down" | "falling down"
                usesBlackKeys: false
            },
            {
                name: "Jingle Bells",
                notes: ['E4', 'E4', 'E4', 'E4', 'E4', 'E4', 'E4', 'G4', 'C4', 'D4', 'E4', 'F4', 'F4', 'F4', 'F4'],
                rhythm: [1, 1, 2, 1, 1, 2, 1, 1, 1.5, 0.5, 4, 1, 1, 1, 1],
                phrases: [3, 6, 11, 15], // "Jingle bells" | "jingle bells" | "jingle all the way" | "oh what fun..."
                usesBlackKeys: false
            },
            {
                name: "Ode to Joy",
                notes: ['E4', 'E4', 'F4', 'G4', 'G4', 'F4', 'E4', 'D4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'D4'],
                rhythm: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.5, 0.5, 2],
                phrases: [4, 8, 12, 15], // First phrase | second phrase | third phrase | ending
                usesBlackKeys: false
            },
            {
                name: "Happy Birthday",
                notes: ['C4', 'C4', 'D4', 'C4', 'F4', 'E4', 'C4', 'C4', 'D4', 'C4', 'G4', 'F4', 'C4', 'C4', 'A4', 'F4', 'E4', 'D4'],
                rhythm: [0.75, 0.25, 1, 1, 1, 2, 0.75, 0.25, 1, 1, 1, 2, 0.75, 0.25, 1, 1, 1, 2],
                phrases: [6, 12, 18], // "Happy birthday to you" | "Happy birthday to you" | "Happy birthday dear..."
                usesBlackKeys: false
            }
        ];

        // Game state
        let currentLevel = 0;
        let currentSequenceIndex = 0;
        let playerSequence = [];
        let isPlaying = false;
        let isWaitingForInput = false;
        let strikes = 0;
        let completedLevels = [];
        let speed = 'normal';
        let startNotes = 3;
        let addNotes = 2;
        let addMode = 'fixed'; // 'fixed' or 'phrase'
        let currentPhraseIndex = 0; // Track which phrase we're on
        let gameStarted = false;
        let pressedKeys = new Set();
        let currentSongBlackKeys = [];
        let rewardFishCount = 0;
        let difficulty = 'medium';

        // Speed multipliers
        const speedMultipliers = {
            slow: 1.67,
            normal: 1,
            fast: 0.67
        };

        // Difficulty note limits
        const difficultyLimits = {
            supereasy: 3,
            easy: 6,
            medium: 12,
            hard: Infinity  // Full song
        };

        // Get max notes for current song based on difficulty
        function getMaxNotes() {
            const song = songs[currentLevel];
            const limit = difficultyLimits[difficulty];
            return Math.min(limit, song.notes.length);
        }

        // DOM elements
        const seal = document.getElementById('seal');
        const shark = document.getElementById('shark');
        const bandaid = document.getElementById('bandaid');
        const smallFish = document.getElementById('smallFish');
        const medals = document.getElementById('medals');
        const levelDisplay = document.getElementById('levelDisplay');
        const instruction = document.getElementById('instruction');
        const sequenceDisplay = document.getElementById('sequenceDisplay');
        const startBtn = document.getElementById('startBtn');
        const retryBtn = document.getElementById('retryBtn');
        const resetBtn = document.getElementById('resetBtn');
        const levelSelect = document.getElementById('levelSelect');
        const difficultySelect = document.getElementById('difficultySelect');
        const speedSelect = document.getElementById('speedSelect');
        const startNotesSelect = document.getElementById('startNotesSelect');
        const addNotesSelect = document.getElementById('addNotesSelect');
        const successMessage = document.getElementById('successMessage');
        const failMessage = document.getElementById('failMessage');
        const piano = document.getElementById('piano');
        const rewardFishContainer = document.getElementById('rewardFishContainer');
        const strikeElements = [
            document.getElementById('strike1'),
            document.getElementById('strike2'),
            document.getElementById('strike3')
        ];

        // Populate level select
        function populateLevelSelect() {
            levelSelect.innerHTML = '';
            songs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1} - ${song.name}`;
                levelSelect.appendChild(option);
            });
        }

        // Build piano dynamically (6 white keys: C D E F G A)
        function buildPiano() {
            const whiteNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4'];
            const blackNotes = [
                { note: 'C#4', position: 0 },
                { note: 'D#4', position: 1 },
                { note: 'F#4', position: 3 },
                { note: 'G#4', position: 4 }
            ];

            // Create white keys
            whiteNotes.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'white-key';
                key.dataset.note = note;
                key.dataset.index = index;

                const label = document.createElement('span');
                label.className = 'note-label';
                label.textContent = note.replace('4', '');
                key.appendChild(label);

                piano.appendChild(key);
            });

            // Create black keys
            blackNotes.forEach(({ note, position }) => {
                const key = document.createElement('div');
                key.className = 'black-key disabled';
                key.dataset.note = note;
                key.dataset.position = position;
                piano.appendChild(key);
            });

            requestAnimationFrame(() => {
                positionBlackKeys();
            });
        }

        // Position black keys relative to white keys
        function positionBlackKeys() {
            const whiteKeys = piano.querySelectorAll('.white-key');
            const blackKeys = piano.querySelectorAll('.black-key');

            blackKeys.forEach(blackKey => {
                const position = parseInt(blackKey.dataset.position);
                const whiteKey = whiteKeys[position];
                if (whiteKey) {
                    const whiteRect = whiteKey.getBoundingClientRect();
                    const pianoRect = piano.getBoundingClientRect();
                    const blackKeyWidth = blackKey.offsetWidth;

                    const leftPos = (whiteRect.right - pianoRect.left) - (blackKeyWidth / 2) - 2;
                    blackKey.style.left = leftPos + 'px';
                }
            });
        }

        window.addEventListener('resize', () => {
            requestAnimationFrame(positionBlackKeys);
        });

        // Update black keys based on current song
        function updateBlackKeyState() {
            const song = songs[currentLevel];
            const blackKeys = piano.querySelectorAll('.black-key');

            // Find which black keys are used in the song
            currentSongBlackKeys = song.notes.filter(note => note.includes('#'));
            const uniqueBlackKeys = [...new Set(currentSongBlackKeys)];

            blackKeys.forEach(key => {
                if (uniqueBlackKeys.includes(key.dataset.note)) {
                    key.classList.remove('disabled');
                } else {
                    key.classList.add('disabled');
                }
            });
        }

        // Create bubbles
        function createBubbles() {
            const bubblesContainer = document.getElementById('bubbles');
            for (let i = 0; i < 8; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.animationDelay = Math.random() * 3 + 's';
                bubble.style.width = (Math.random() * 8 + 4) + 'px';
                bubble.style.height = bubble.style.width;
                bubblesContainer.appendChild(bubble);
            }
        }

        // Update medals display
        function updateMedals() {
            medals.innerHTML = '';
            const sortedLevels = [...completedLevels].sort((a, b) => a - b);
            sortedLevels.forEach((level) => {
                const medal = document.createElement('div');
                medal.className = 'medal';
                medal.innerHTML = `
                    <div class="medal-circle">${level + 1}</div>
                    <div class="medal-ribbon"></div>
                `;
                medals.appendChild(medal);
            });
        }

        // Update strikes display
        function updateStrikes() {
            strikeElements.forEach((el, i) => {
                el.classList.toggle('active', i < strikes);
            });
        }

        // Add reward fish to iceberg
        function addRewardFish() {
            rewardFishCount++;
            const fish = document.createElement('div');
            fish.className = 'reward-fish';
            fish.innerHTML = `
                <div class="fish-body">
                    <div class="fish-tail"></div>
                    <div class="fish-eye"></div>
                </div>
            `;
            rewardFishContainer.appendChild(fish);

            // Animate the fish appearing
            setTimeout(() => {
                fish.classList.add('visible');
            }, 50);
        }

        // Clear reward fish
        function clearRewardFish() {
            rewardFishContainer.innerHTML = '';
            rewardFishCount = 0;
        }

        // Highlight key
        function highlightKey(note, duration = 500) {
            const key = document.querySelector(`[data-note="${note}"]`);
            if (key) {
                const isBlack = note.includes('#');

                if (isBlack) {
                    key.classList.add('highlight');
                } else {
                    const noteLetter = note.charAt(0);
                    key.classList.add(`highlight-${noteLetter}`);
                }
                key.classList.add('pressed');

                setTimeout(() => {
                    if (isBlack) {
                        key.classList.remove('highlight');
                    } else {
                        const noteLetter = note.charAt(0);
                        key.classList.remove(`highlight-${noteLetter}`);
                    }
                    key.classList.remove('pressed');
                }, duration);
            }
        }

        // Play sequence with rhythm
        async function playSequence(sequence, startIndex = 0) {
            const multiplier = speedMultipliers[speed];
            const song = songs[currentLevel];
            const baseTime = 400; // Base time for a quarter note

            for (let i = startIndex; i < sequence.length; i++) {
                if (!isPlaying) return;

                const note = sequence[i];
                const rhythmValue = song.rhythm[i] || 1;
                const noteDuration = baseTime * rhythmValue * multiplier;
                const playDuration = Math.min(noteDuration * 0.8, 600 * multiplier);

                playNote(note, playDuration / 1000);
                highlightKey(note, playDuration);

                await new Promise(resolve => setTimeout(resolve, noteDuration));
            }
        }

        // Seal animations
        function sealDive() {
            seal.classList.remove('returning', 'swimming', 'diving');
            void seal.offsetWidth;
            seal.classList.add('diving');
            setTimeout(() => {
                if (seal.classList.contains('diving')) {
                    seal.classList.remove('diving');
                    seal.classList.add('swimming');
                }
            }, 800);
        }

        function sealReturn(showFish = true) {
            seal.classList.remove('swimming', 'diving');
            seal.classList.add('returning');

            smallFish.classList.remove('visible');

            if (showFish) {
                setTimeout(() => {
                    smallFish.classList.add('visible');
                    setTimeout(() => smallFish.classList.remove('visible'), 2000);
                }, 400);
            }
        }

        function resetSeal() {
            seal.classList.remove('swimming', 'diving', 'returning');
            smallFish.classList.remove('visible');
        }

        // Shark attack
        async function sharkAttack() {
            piano.classList.remove('ready'); // Dim keys during attack
            shark.classList.add('attacking');
            await new Promise(resolve => setTimeout(resolve, 1000));

            bandaid.classList.add('visible');

            await new Promise(resolve => setTimeout(resolve, 500));
            shark.classList.remove('attacking');

            sealReturn(false);

            failMessage.classList.add('visible');
            setTimeout(() => failMessage.classList.remove('visible'), 2000);
        }

        // Start game
        async function startGame() {
            initAudio();
            gameStarted = true;
            isPlaying = true;
            isWaitingForInput = false;
            strikes = 0;
            currentPhraseIndex = 0; // Reset phrase tracking
            // For phrase mode, we'll set currentSequenceIndex in playNextSequence
            // For fixed mode, use the old calculation
            if (addMode === 'phrase') {
                currentSequenceIndex = 0; // Will be set to first phrase in playNextSequence
            } else {
                currentSequenceIndex = startNotes - addNotes; // Will be incremented by addNotes
            }
            playerSequence = [];
            bandaid.classList.remove('visible');
            resetSeal();
            clearRewardFish();
            updateBlackKeyState();

            updateStrikes();

            startBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            resetBtn.style.display = 'inline-block';
            levelSelect.disabled = true;
            difficultySelect.disabled = true;
            speedSelect.disabled = true;
            startNotesSelect.disabled = true;
            addNotesSelect.disabled = true;

            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            levelDisplay.textContent = `${song.name} (${maxNotes} notes)`;
            instruction.textContent = 'Watch and listen...';
            sequenceDisplay.textContent = '';

            sealDive();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await playNextSequence();
        }

        // Play next sequence
        async function playNextSequence() {
            if (!isPlaying) return;

            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            currentSequenceIndex += addNotes;

            // Don't exceed difficulty limit or song length
            if (currentSequenceIndex > maxNotes) {
                currentSequenceIndex = maxNotes;
            }

            if (currentSequenceIndex > maxNotes ||
                (playerSequence.length > 0 && currentSequenceIndex === playerSequence.length)) {
                await levelComplete();
                return;
            }

            // Check if we've completed all notes for this difficulty
            if (playerSequence.length >= maxNotes) {
                await levelComplete();
                return;
            }

            isWaitingForInput = false;
            piano.classList.remove('ready'); // Dim keys while computer plays
            const sequence = song.notes.slice(0, currentSequenceIndex);
            instruction.textContent = `Listen to ${currentSequenceIndex} note${currentSequenceIndex > 1 ? 's' : ''}...`;
            sequenceDisplay.textContent = '';

            await new Promise(resolve => setTimeout(resolve, 500));

            if (!isPlaying) return;

            await playSequence(sequence);

            if (!isPlaying) return;

            instruction.textContent = 'Your turn! Play the notes.';
            playerSequence = [];
            sequenceDisplay.textContent = `Notes: 0/${currentSequenceIndex}`;
            piano.classList.add('ready'); // Light up keys to show player can play
            isWaitingForInput = true;
        }

        // Handle key press
        function handleKeyPress(note) {
            if (!isPlaying || !isWaitingForInput || currentSequenceIndex === 0) return;

            // Check if this is a disabled black key
            const key = document.querySelector(`[data-note="${note}"]`);
            if (key && key.classList.contains('disabled')) return;

            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            const expectedNote = song.notes[playerSequence.length];

            playNote(note, 0.3);
            highlightKey(note, 300);

            playerSequence.push(note);
            sequenceDisplay.textContent = `Notes: ${playerSequence.length}/${currentSequenceIndex}`;

            if (note !== expectedNote) {
                isWaitingForInput = false;
                handleMistake();
            } else if (playerSequence.length === currentSequenceIndex) {
                isWaitingForInput = false;
                // Add a reward fish for successfully playing the sequence
                addRewardFish();
                // Check if difficulty level is complete
                if (currentSequenceIndex >= maxNotes) {
                    setTimeout(() => levelComplete(), 500);
                } else {
                    setTimeout(() => playNextSequence(), 500);
                }
            }
        }

        // Handle mistake
        async function handleMistake() {
            strikes++;
            updateStrikes();
            playerSequence = [];

            if (strikes >= 3) {
                isPlaying = false;
                isWaitingForInput = false;
                await sharkAttack();
                strikes = 0;
                updateStrikes();

                setTimeout(() => {
                    retryBtn.style.display = 'inline-block';
                    resetBtn.style.display = 'none';
                    levelSelect.disabled = false;
                    difficultySelect.disabled = false;
                    speedSelect.disabled = false;
                    startNotesSelect.disabled = false;
                    addNotesSelect.disabled = false;
                    instruction.textContent = 'Oh no! The shark got you! Try again?';
                }, 2500);
            } else {
                sealReturn(false);
                piano.classList.remove('ready'); // Dim keys during replay
                instruction.textContent = `Oops! Wrong note. ${3 - strikes} tries left. Watch again...`;

                setTimeout(async () => {
                    if (!isPlaying) return;

                    sealDive();
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (!isPlaying) return;

                    const sequence = songs[currentLevel].notes.slice(0, currentSequenceIndex);
                    instruction.textContent = `Listen to ${currentSequenceIndex} note${currentSequenceIndex > 1 ? 's' : ''}...`;

                    await playSequence(sequence);

                    if (!isPlaying) return;

                    instruction.textContent = 'Your turn! Play the notes.';
                    playerSequence = [];
                    sequenceDisplay.textContent = `Notes: 0/${currentSequenceIndex}`;
                    piano.classList.add('ready'); // Light up keys to show player can play
                    isWaitingForInput = true;
                }, 2000);
            }
        }

        // Level complete
        async function levelComplete() {
            isPlaying = false;
            isWaitingForInput = false;

            sealReturn(true); // Show small fish on level complete

            if (!completedLevels.includes(currentLevel)) {
                completedLevels.push(currentLevel);
                updateMedals();
            }

            successMessage.classList.add('visible');

            await new Promise(resolve => setTimeout(resolve, 3000));
            successMessage.classList.remove('visible');

            if (currentLevel < songs.length - 1) {
                currentLevel++;
                levelSelect.value = currentLevel;
                instruction.textContent = `Great job! Ready for Level ${currentLevel + 1}?`;
                startBtn.textContent = 'Next Level';
            } else {
                instruction.textContent = 'Congratulations! You completed all levels!';
                startBtn.textContent = 'Play Again';
                currentLevel = 0;
                levelSelect.value = currentLevel;
            }

            startBtn.style.display = 'inline-block';
            resetBtn.style.display = 'none';
            levelSelect.disabled = false;
            difficultySelect.disabled = false;
            speedSelect.disabled = false;
            startNotesSelect.disabled = false;
            addNotesSelect.disabled = false;
            sequenceDisplay.textContent = '';
        }

        // Retry level
        function retryLevel() {
            retryBtn.style.display = 'none';
            currentSequenceIndex = 0;
            resetSeal();
            startGame();
        }

        // Reset game completely
        function resetGame() {
            isPlaying = false;
            isWaitingForInput = false;
            strikes = 0;
            currentSequenceIndex = 0;
            playerSequence = [];

            resetSeal();
            bandaid.classList.remove('visible');
            shark.classList.remove('attacking');
            clearRewardFish();
            piano.classList.remove('ready'); // Dim keys when game resets

            updateStrikes();

            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            levelDisplay.textContent = `${song.name} (${maxNotes} notes)`;
            instruction.textContent = 'Press Start to begin!';
            sequenceDisplay.textContent = '';

            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Start';
            retryBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            levelSelect.disabled = false;
            difficultySelect.disabled = false;
            speedSelect.disabled = false;
            startNotesSelect.disabled = false;
            addNotesSelect.disabled = false;

            updateBlackKeyState();
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            currentLevel = parseInt(levelSelect.value);
            currentSequenceIndex = 0;
            startBtn.textContent = 'Start';
            startGame();
        });

        retryBtn.addEventListener('click', retryLevel);

        resetBtn.addEventListener('click', resetGame);

        levelSelect.addEventListener('change', (e) => {
            currentLevel = parseInt(e.target.value);
            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            levelDisplay.textContent = `${song.name} (${maxNotes} notes)`;
            instruction.textContent = 'Press Start to begin!';
            startBtn.textContent = 'Start';
            updateBlackKeyState();
        });

        difficultySelect.addEventListener('change', (e) => {
            difficulty = e.target.value;
            const song = songs[currentLevel];
            const maxNotes = getMaxNotes();
            levelDisplay.textContent = `${song.name} (${maxNotes} notes)`;
        });

        speedSelect.addEventListener('change', (e) => {
            speed = e.target.value;
        });

        startNotesSelect.addEventListener('change', (e) => {
            startNotes = parseInt(e.target.value);
        });

        addNotesSelect.addEventListener('change', (e) => {
            if (e.target.value === 'phrase') {
                addMode = 'phrase';
            } else {
                addMode = 'fixed';
                addNotes = parseInt(e.target.value);
            }
        });

        // Piano key events
        piano.addEventListener('mousedown', (e) => {
            const key = e.target.closest('.white-key, .black-key');
            if (key && key.dataset.note && !key.classList.contains('disabled')) {
                handleKeyPress(key.dataset.note);
            }
        });

        piano.addEventListener('touchstart', (e) => {
            e.preventDefault();

            Array.from(e.touches).forEach(touch => {
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                const key = element ? element.closest('.white-key, .black-key') : null;
                if (key && key.dataset.note && !key.classList.contains('disabled')) {
                    handleKeyPress(key.dataset.note);
                }
            });
        }, { passive: false });

        // Keyboard support
        const keyboardMap = {
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
            'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4'
        };

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;

            const keyLower = e.key.toLowerCase();

            if (pressedKeys.has(keyLower)) return;
            pressedKeys.add(keyLower);

            if (!gameStarted) {
                initAudio();
            }

            const note = keyboardMap[keyLower];
            if (note) {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key && !key.classList.contains('disabled')) {
                    handleKeyPress(note);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            pressedKeys.delete(e.key.toLowerCase());
        });

        // Initialize
        populateLevelSelect();
        buildPiano();
        createBubbles();
        updateMedals();
        updateStrikes();
        updateBlackKeyState();
    </script>
</body>
</html>
